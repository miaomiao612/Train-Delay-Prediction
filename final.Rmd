---
title: "final project"
author: "Yifei Sun & Kathleen Scopis"
date: "2022-12-01"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup_13, cache=TRUE, message=FALSE}

library(tidyverse)
library(tigris)
library(sf)
library(chron)
library(timeDate)
library(lubridate)
library(tidycensus)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RSocrata)
library(ggplot2)
library(spdep)
library(caret)
library(ckanr)
library(grid)
library(ggcorrplot)
library(gganimate)

options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.2),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2 <- c("#6baed6","#08519c")


```



```{r read_dat }
dat <- read.csv(file.path("2019_01.csv"))
station <-read.csv(file.path("data/stops.csv"))
dat<-merge(dat, station, by.x="from", by.y="stop_name")
dat <- dat%>%
  rename(
         from_lat = stop_lat,
         from_lng = stop_lon,
         from_zone_id=zone_id)
dat<-merge(dat, station, by.x="to", by.y="stop_name")
dat <- dat%>%
  rename(
         to_lat = stop_lat,
         to_lng = stop_lon,
         to_zone_id=zone_id)%>%
  dplyr::select(-stop_id.x,-stop_code.x,-stop_id.y,-stop_code.y)
write.csv(dat, "C:\\Upenn\\d.csv", row.names=FALSE)

```

create interval 60 
```{r time_bins }
dat <- dat %>%
  mutate(interval60 = floor_date(ymd_hm(scheduled_time), unit = "hour"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE))
```


```{r get_census and extract_geometries, message=FALSE, warning=FALSE, cache=TRUE, results = 'hide'}
NJCensus <- 
  get_acs(geography = "tract", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2018, 
          state = "NJ", 
          geometry = TRUE, 
          
          output = "wide")

NJTracts <- 
  NJCensus %>%
  as.data.frame() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  select(GEOID, geometry) %>% 
  st_sf

```

```{r add_census_tracts , message = FALSE, warning = FALSE}
dat_census <- st_join(dat %>% 
          filter(is.na(from_lng) == FALSE &
                   is.na(from_lat) == FALSE &
                   is.na(to_lat) == FALSE &
                   is.na(to_lng) == FALSE) %>%
          st_as_sf(., coords = c("from_lng", "from_lat"), crs = 4326),
        NJTracts %>%
          st_transform(crs=4326),
        join=st_intersects,
              left = TRUE) %>%
  rename(From.Tract = GEOID) %>%
  mutate(from_lng = unlist(map(geometry, 1)),
         from_lat = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)%>%
  st_as_sf(., coords = c("to_lng", "to_lat"), crs = 4326) %>%
  st_join(., NJTracts %>%
            st_transform(crs=4326),
          join=st_intersects,
          left = TRUE) %>%
  rename(To.Tract = GEOID)  %>%
  mutate(to_lng = unlist(map(geometry, 1)),
         to_lat = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)%>%
  na.omit

```


```{r import_weather, message = FALSE, warning = FALSE }
weather.Data <- 
  riem_measures(station = "WRI", date_start = "2019-01-01", date_end = "2019-01-31")
weather.Panel  <-  
  weather.Data %>%
  dplyr::select(valid, tmpf, p01i, sknt, vsby)%>%
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt),
              Visibility = max(vsby)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

```



```{r plot_weather, catche = TRUE}
grid.arrange( ncol=2,
  ggplot(weather.Panel, aes(interval60,Precipitation)) + geom_line() + 
    labs(title="Percipitation", x="Hour", y="Perecipitation") + plotTheme,
  ggplot(weather.Panel, aes(interval60,Wind_Speed)) + geom_line() + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed") + plotTheme,
  ggplot(weather.Panel, aes(interval60,Temperature)) + geom_line() + 
    labs(title="Temperature", x="Hour", y="Temperature") + plotTheme,
  ggplot(weather.Panel, aes(interval60,Visibility)) + geom_line() + 
    labs(title="Visibility", x="Hour", y="Visibility") + plotTheme,
  top="Weather Data - NJ Metro Area - 2019")

```

## Explore the data

```{r explore data}
ggplot(dat_census %>%
         group_by(interval60) %>%
         tally())+
  geom_line(aes(x = interval60, y=n))+

  labs(title="Delay time per hr. New Jersey, Jan, 2019",
       x="Date", 
       y="Number of minutes")+
  plotTheme

```

```{r}
dat_census %>%
        mutate(time_of_day = case_when(hour(interval60) < 7 | hour(interval60) > 18 ~ "Overnight",
                                 hour(interval60) >= 7 & hour(interval60) < 10 ~ "AM Rush",
                                 hour(interval60) >= 10 & hour(interval60) < 15 ~ "Mid-Day",
                                 hour(interval60) >= 15 & hour(interval60) <= 18 ~ "PM Rush"))%>%
         group_by(interval60, from, time_of_day) %>%
         tally()%>%
  group_by(from, time_of_day)%>%
  summarize(mean_delay_minutes = mean(n))%>%
  ggplot()+
  geom_histogram(aes(mean_delay_minutes), binwidth = 1)+
  labs(title="New Jersey, Jan, 2019",
       x="Number of delay minutes", 
       y="Frequency")+
  facet_wrap(~time_of_day)+
  plotTheme
```


```{r}
ggplot(dat_census %>%
         group_by(interval60, line) %>%
         tally())+
  geom_histogram(aes(n), binwidth = 5)+
  labs(title="delay time per hr by train lines. New Jersey, Jan, 2019",
       x="delay time", 
       y="Number of train lines")+
  plotTheme
```
```{r}
ggplot(dat_census %>% mutate(hour = hour(actual_time)))+
     geom_freqpoly(aes(hour, color = dotw), binwidth = 1)+
  labs(title="Delay time in New Jersey,  by day of the week, Jan, 2019",
       x="Hour", 
       y="delay time")+
     plotTheme


```
```{r}
ggplot(dat_census %>% 
         mutate(hour = hour(actual_time),
                weekend = ifelse(dotw %in% c("周六", "周日"), "Weekend", "Weekday")))+
     geom_freqpoly(aes(hour, color = weekend), binwidth = 1)+
  labs(title="Train delay time in New Jersey, - weekend vs weekday, Jan, 2019",
       x="Hour", 
       y="delay time")+
     plotTheme
```
```{r}
ggplot()+
  geom_sf(data = NJTracts %>%
          st_transform(crs=4326))+
  geom_point(data = dat_census %>% 
            mutate(hour = hour(actual_time),
                weekend = ifelse(dotw %in% c("周六", "周日"), "Weekend", "Weekday"),
                time_of_day = case_when(hour(interval60) < 7 | hour(interval60) > 18 ~ "Overnight",
                                 hour(interval60) >= 7 & hour(interval60) < 10 ~ "AM Rush",
                                 hour(interval60) >= 10 & hour(interval60) < 15 ~ "Mid-Day",
                                 hour(interval60) >= 15 & hour(interval60) <= 18 ~ "PM Rush"))%>%
              group_by(from, from_lat, from_lng, weekend, time_of_day) %>%
              tally(),
            aes(x=from_lng, y = from_lat, color = n), 
            fill = "transparent", alpha = 1, size = 1.5)+
  scale_colour_viridis(direction = -1,
  discrete = FALSE, option = "D")+
  ylim(min(dat_census$from_lat), max(dat_census$from_lat))+
  xlim(min(dat_census$from_lng), max(dat_census$from_lng))+
  facet_grid(weekend ~ time_of_day)+
  labs(title="Train delay time by station. New Jersey, Jan, 2019")+
  mapTheme
```

merge weather panel and NJTracts
```{r}

trip_panel<-merge(dat_census, weather.Panel)%>%
  rename(GEOID=From.Tract)%>%
left_join(NJTracts, trip_panel1, by='GEOID')%>%
  rename(geometry1=geometry)
trip_panel$format_date<-format(trip_panel$interval60, "%Y-%m-%d")


```

```{r}

trip_panel <- trip_panel %>%
  mutate(holiday = case_when(
    scheduled_time == 1   ~ 1,    # New Year's Day
    scheduled_time == 32  ~ 1,   # Martin Luther King Jr. Day
    scheduled_time == 121 ~ 1,  # Memorial Day
    scheduled_time == 153 ~ 1,  # Independence Day
    scheduled_time == 217 ~ 1,  # Labor Day
    scheduled_time == 286 ~ 1,  # Thanksgiving Day
    scheduled_time == 359 ~ 1,  # Christmas Day
    TRUE                  ~ 0              # Other days
  ))

 
```



time lag variables
```{r time_lags , message = FALSE}
trip_panel <- 
  trip_panel %>% 
  arrange( interval60) %>% 
  mutate(lagHour = dplyr::lag(delay_minutes,1),
         lag2Hours = dplyr::lag(delay_minutes,2),
         lag3Hours = dplyr::lag(delay_minutes,3),
         lag4Hours = dplyr::lag(delay_minutes,4),
         lag12Hours = dplyr::lag(delay_minutes,12),
         lag1day = dplyr::lead(delay_minutes,24),
         leadHour = dplyr::lead(delay_minutes,1),
         lead2Hours = dplyr::lead(delay_minutes,2),
         lead3Hours = dplyr::lead(delay_minutes,3),
         lead4Hours = dplyr::lead(delay_minutes,4),
         lead12Hours = dplyr::lead(delay_minutes,12),
         lead1day = dplyr::lead(delay_minutes,24)
        )%>%
  mutate(holidayLag = case_when(dplyr::lag(holiday, 1) == 1 ~ "PlusOneDay",
                                 dplyr::lag(holiday, 2) == 1 ~ "PlustTwoDays",
                                 dplyr::lag(holiday, 3) == 1 ~ "PlustThreeDays",
                                 dplyr::lead(holiday, 1) == 1 ~ "MinusOneDay",
                                 dplyr::lead(holiday, 2) == 1 ~ "MinusTwoDays",
                                 dplyr::lead(holiday, 3) == 1 ~ "MinusThreeDays"))%>%
    
   mutate(holidayLag = ifelse(is.na(holidayLag),0,holidayLag))
        
    
    
```


```{r evaluate_lags , warning = FALSE, message = FALSE}
as.data.frame(trip_panel) %>%
    group_by(interval60) %>% 
    summarise_at(vars(starts_with("lag"), "delay_minutes"), mean, na.rm = TRUE) %>%
    gather(Variable, Value, -interval60, -delay_minutes) %>%
    mutate(Variable = factor(Variable, levels=c("lagHour","lag2Hours","lag3Hours","lag4Hours",
                                                "lag12Hours","lag1day")))%>%
    group_by(Variable) %>%  
    summarize(correlation = round(cor(Value, delay_minutes),2))
```
```{r evaluate_leads , warning = FALSE, message = FALSE}
as.data.frame(trip_panel) %>%
    group_by(interval60) %>% 
    summarise_at(vars(starts_with("lead"), "delay_minutes"), mean, na.rm = TRUE) %>%
    gather(Variable, Value, -interval60, -delay_minutes) %>%
    mutate(Variable = factor(Variable, levels=c("leadHour","lead2Hours","lead3Hours","lead4Hours",
                                                "lead12Hours","lead1day")))%>%
    group_by(Variable) %>%  
    summarize(correlation = round(cor(Value, delay_minutes),2))
```





split
```{r}
trip.Train <- filter(trip_panel, week < 4)
trip.Test <- filter(trip_panel, week >= 4)
```


delay time by week
```{r}
mondays <- 
  mutate(trip_panel,
         monday = ifelse(dotw == "周一" & hour(interval60) == 1,
                         interval60, 0)) %>%
  filter(monday != 0) 

tg   <- as.POSIXct("2018-11-22 01:00:00 UTC")
xmas <- as.POSIXct("2018-12-24 01:00:00 UTC")

st_drop_geometry(rbind(
  mutate(trip.Train, Legend = "Training"), 
  mutate(trip.Test, Legend = "Testing"))) %>%
    group_by(Legend, interval60) %>% 
      summarize(delay_minutes = sum(delay_minutes)) %>%
      ungroup() %>% 
      ggplot(aes(interval60, delay_minutes, colour = Legend)) + geom_line() +
        scale_colour_manual(values = palette2) +
        geom_vline(data = mondays, aes(xintercept = monday)) +
        labs(title="delay time by week: 12.31-1.28",
             subtitle="Dotted lines for Thanksgiving & Christmas", 
             x="Day", y="Trip Count") +
         theme(panel.grid.major = element_blank())   
```

delay time by hour
```{r trip_timeseries }
ggplot(trip_panel %>%
         group_by(interval60) %>%
         tally())+
  geom_line(aes(x = interval60, y = n))+
  labs(title="delay time per hour NJ, 12.31-1.28, 2019",
       x="Date", 
       y="delay time")+
  plotTheme
```
```{r spatial_correlation}
group_by(trip_panel, week, GEOID) %>%
  summarize(Sum_delay_minutes = sum(delay_minutes)) %>%
  ungroup() %>% 
  ggplot() + geom_sf(aes(fill = q5(Sum_delay_minutes))) +
    facet_wrap(~week, ncol = 8) +
    scale_fill_manual(values = palette5,
                      labels = c("16", "140", "304", "530", "958"),
                      name = "delay time") +
    labs(title="Sum of delay time by tract and week") +
     theme(legend.position = "bottom") 
```



train the model:
```{r}
reg1 <- lm(delay_minutes~Temperature+Precipitation+Wind_Speed+Visibility, data=trip.Train )
reg2 <- 
  lm(delay_minutes ~  line+holiday +  hour(interval60) + Temperature + Precipitation +Wind_Speed+Visibility+from, 
     data=trip.Train)
reg3 <- 
  lm(delay_minutes ~  line+holiday +  hour(interval60) + Temperature + Precipitation +Wind_Speed+Visibility+lagHour + lag2Hours +lag3Hours + lag12Hours + lag1day+holidayLag+leadHour+lead2Hours+lead3Hours+lead4Hours+lead12Hours+lead1day+from, 
     data=trip.Train)

```
        

nest data
```{r}
trip.Test.weekNest <- 
  as.data.frame(trip.Test) %>%
  nest(-week) 


```
validate by time:

```{r}
model_pred <- function(dat, fit){
   pred <- predict(fit, newdata = dat)}
```

Check the Mean Absolute Errors of each model

```{r do_predicitons }
week_predictions <- 
  trip.Test.weekNest %>% 
    mutate(reg1= map(.x = data, fit = reg1, .f = model_pred),
           reg2= map(.x = data, fit = reg2, .f = model_pred),
           reg3= map(.x = data, fit = reg3, .f = model_pred),) %>% 
    gather(Regression, Prediction, -data, -week) %>%
    mutate(Observed = map(data, pull, delay_minutes),
           Absolute_Error = map2(Observed, Prediction,  ~ abs(.x - .y)),
           MAE = map_dbl(Absolute_Error, mean, na.rm = TRUE),
           sd_AE = map_dbl(Absolute_Error, sd, na.rm = TRUE))
week_predictions
```



Plot Mean Absolute Errors of each model in week 18&19
From the visualization result we can find that models which considered time lag perform better.

```{r plot_errors_by_model }
week_predictions %>%
  dplyr::select(week, Regression, MAE) %>%
  gather(Variable, MAE, -Regression, -week) %>%
  ggplot(aes(week, MAE)) + 
    geom_bar(aes(fill = Regression), position = "dodge", stat="identity") +
    scale_fill_manual(values = palette5) +
    labs(title = "Mean Absolute Errors by model specification and week") +
  plotTheme
```
validate by space:
```{r}
error.byWeek <-
  filter(week_predictions, Regression == "reg2") %>% 
  unnest() %>% st_sf() %>%
  dplyr::select(Pickup.Census.Tract, Absolute_Error, week, geometry) %>%
  gather(Variable, Value, -Pickup.Census.Tract, -week, -geometry) %>%
    group_by(Variable, Pickup.Census.Tract, week) %>%
    summarize(MAE = mean(Value))
```

```{r errors_by_station, warning = FALSE, message = FALSE }
week_predictions %>% 
    mutate(interval60 = map(data, pull, interval60),
           start_station_id = map(data, pull, start_station_id), 
           start_lat = map(data, pull, start_lat), 
           start_lng = map(data, pull, start_lng)) %>%
    select(interval60, start_station_id, start_lng, start_lat, Observed, Prediction, Regression) %>%
    unnest() %>%
  filter(Regression == "ETime_Space_FE_timeLags_holidayLags") %>%
  group_by(start_station_id, start_lng, start_lat) %>%
  summarize(MAE = mean(abs(Observed-Prediction), na.rm = TRUE))%>%
ggplot(.)+
  geom_sf(data = WCensus, color = "black", fill = "transparent")+
  geom_point(aes(x = start_lng, y = start_lat, color = MAE), 
             fill = "transparent", alpha = 0.4)+
  scale_colour_viridis(direction = -1,
  discrete = FALSE, option = "D")+
  ylim(min(dat_census$start_lat), max(dat_census$start_lat))+
  xlim(min(dat_census$start_lng), max(dat_census$start_lng))+
  labs(title="Mean Abs Error, Test Set, Model 5")+
  mapTheme
```

plot the delay time in time series of both prediction and observation

```{r error_vs_actual_timeseries , warning = FALSE, message = FALSE}
week_predictions %>% 
    mutate(interval60 = map(data, pull, interval60),
           from_id = map(data, pull, from_id)) %>%
    dplyr::select(interval60, from_id, Observed, Prediction, Regression) %>%
    unnest() %>%
    gather(Variable, Value, -Regression, -interval60, -from_id) %>%
    group_by(Regression, Variable, interval60) %>%
    summarize(Value = sum(Value)) %>%
    ggplot(aes(interval60, Value, colour=Variable)) + 
      geom_line(size = 1.1) + 
      facet_wrap(~Regression, ncol=1) +
      labs(title = "Predicted/Observed delay time in time series", subtitle = "NJ; A test set of 2 weeks",  x = "Hour", y= "delay minutes") +
      plotTheme
```




cv-kfolds
```{r cross validation}
fitControl <- trainControl(method = "cv", number = 5)
set.seed(825)

reg.cv <- 
  train(delay_minutes ~ ., data = trip_panel %>% 
                                dplyr::select(delay_minutes,line,holiday ,Temperature, Precipitation,Wind_Speed,Visibility,lagHour ,lag2Hours ,lag3Hours , lag12Hours , lag1day , holidayLag,leadHour,lead2Hours,lead3Hours,lead4Hours,lead12Hours,lead1day,from), 
     method = "lm", trControl = fitControl, na.action = na.pass)

reg.cv

```
 cross-validation output 
```{r}
reg.cv$resample[1:5,]
```



